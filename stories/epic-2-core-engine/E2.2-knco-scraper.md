# E2.2: KNCO RSS Scraper

**Epic:** E2 - Core Scraping Engine
**Story ID:** E2.2
**Story Points:** 5
**Priority:** P0 (Critical)
**Type:** Feature
**Status:** ✅ Complete

---

## User Story

**As a** developer
**I want to** fetch and parse events from KNCO Trumba RSS feed
**So that** I can extract structured event data

---

## Acceptance Criteria

- [x] Implement `src/scrapers/base.py` with `BaseScraper` abstract class
- [x] Implement `src/scrapers/knco.py` with `KNCOScraper(BaseScraper)`
- [x] Fetch RSS feed via HTTP GET (handle 404/timeout)
- [x] Parse XML using `feedparser`
- [x] Extract all required fields (see below)
- [x] Handle HTML entities (`&amp;nbsp;` → ` `)
- [x] Extract `source_event_id` from GUID (regex: `event/(\d+)`)
- [x] Return list of normalized event dictionaries
- [x] Log scraping statistics (events found, errors)
- [x] Unit test with sample RSS fixture

---

## Fields to Extract

```python
{
    'title': str (required),
    'description': str (required, strip HTML tags),
    'event_date': str (required, ISO format),
    'venue': str (optional, parse from description),
    'city_area': str (optional, parse from description),
    'age_range': str (optional, parse from description),
    'price': str (optional, parse from description),
    'is_free': bool (infer from price or keywords),
    'source_url': str (required, RSS item link),
    'source_event_id': str (required, from GUID),
}
```

---

## HTML Parsing Example

**Description HTML:**
```html
<b>City/Area</b>:&amp;nbsp;Nevada City<br/>
<b>Age</b>:&nbsp;3-5 years<br/>
<b>Price</b>: Free
```

**Extracted:**
```python
city_area = "Nevada City"
age_range = "3-5 years"
price = "Free"
is_free = True
```

---

## Dependencies

**Depends on:** E2.1 (Python Setup)
**Blocks:** E2.3 (Normalizer), E2.6 (Orchestrator)

---

## Definition of Done

- [x] Scraper returns 200+ events from KNCO
- [x] All fields extracted correctly (validated with sample)
- [x] Unit test passes with fixture
- [x] No unhandled exceptions
- [x] Logging provides useful debug info

---

## Technical Notes

- Use regex patterns for HTML metadata extraction (from n8n learnings)
- Handle both `&nbsp;` and `&amp;nbsp;` variations
- GUID format: `http://uid.trumba.com/event/177609910` → extract `177609910`

---

**Created:** 2025-10-07
**Last Updated:** 2025-10-08
**Completed:** 2025-10-07

---

## Dev Agent Record

### Bug Fixes (2025-10-08)

**Issue:** Scraper returned 0 events when tested with live data during integration testing

**Root Causes:**
1. **Wrong RSS URL** - Implementation used `https://www.trumba.com/calendars/tourism-knco.rss` instead of `https://www.trumba.com/calendars/KNCO.rss` from Epic 1 research
2. **Missing date extraction** - `_extract_date()` method only checked `published_parsed` field which doesn't exist in Trumba RSS feed
3. **Dates located in `category` field** - Trumba uses format: `"2025/10/07 (Tue)"`

**Fixes Applied:**
- Updated `RSS_URL` to match Epic 1 validated URL: `https://www.trumba.com/calendars/KNCO.rss`
- Enhanced `_extract_date()` method to parse dates from multiple sources:
  - Category field (primary): `2025/10/07 (Tue)` format using regex `\d{4}/\d{2}/\d{2}`
  - Description field (fallback): `"Tuesday, October 7, 2025"` format
  - Published field (if available)

**Live Integration Test Results (2025-10-08):**
- ✅ 200 events scraped successfully from live KNCO feed
- ✅ 200 events normalized with quality scores
- ✅ 188 unique events after deduplication (12 duplicates removed)
- ✅ Full pipeline Epics 1-3 validated end-to-end with live data

**Modified Files:**
- `src/scrapers/knco.py` - Fixed RSS_URL and enhanced date extraction logic

---

## Dev Agent Record

### Completion Notes
- Implemented KNCOScraper with full RSS parsing via feedparser
- HTML description parsing with BeautifulSoup extracts all metadata fields
- Regex patterns handle various HTML entity encodings (&nbsp;, &amp;nbsp;)
- Event ID extraction from GUID working correctly
- All 5 unit tests passing
- Error handling for network timeouts and parsing failures
- Logging implemented for debugging and statistics
